/*!
 * C-Like Data Structure for JavaScript.
 *
 * @author Joon Kyoung (aka. Firejune)
 * @license MIT
 * @version 0.6.8
 *
 */

(function(C,p){function x(a){return!!a&&a.constructor===A}function u(a){return!!a&&a===Array||a.constructor===Array}function s(a){return!!a&&a===String||a.constructor===String}function v(a){return!!a&&a===ArrayBuffer||a.constructor===ArrayBuffer}function y(a){return a.charAt(0).toUpperCase()+a.slice(1)}function z(a,c){var b={},e=null,h;for(h in a)if(a.hasOwnProperty(h))if((e=a[h])&&e===Object||e.constructor===Object)b[h]=z(e,c);else if(e=c(e,h,b)){b=e;break}return b}function D(a,c){for(var b in c)a.hasOwnProperty(b)&&
(a[b]&&a[b]===Object||a[b].constructor===Object?a[b]=D(a[b],c[b]):a[b][1]=c[b]);return a}function F(a,c){return z(a,function(b,a,h){var r=u(b)&&b[0]||b,r=x(r)&&r||r.toLowerCase(),l=s(b)?c:b[1],d=u(b)&&3<=b.length&&b[2]||(s(l)||u(l)||v(l))&&l.length||v(l)&&l.byteLength||1;b=u(b)&&(s(d)||1<d)?s(d)&&b[3]===p&&!0||b[3]:!1;h[a]=[r,l,d,b]})}function E(a){var c=0;z(a,function(b,a){var h=b[0],r=b[1],l=b[2],d=b[3],B=w[h],f="uint8";B===p&&x(h)&&(B=h.byteLength);s(l)&&(f=l,l=r.byteLength||r.length);!0===d&&
(c+=w[f]);c+=l*B});return c}var A=function(a,c,b){this.endian=b==p&&!0||b;this.defaultValue=c||0;this.struct=F(a,this.defaultValue);this.byteLength=E(this.struct);this.emptyBuffer=new ArrayBuffer(this.byteLength);this.constructor=A;this._debug=!1;this._struct={}};A.prototype={update:function(a){this.struct=D(this.struct,a||{});this.byteLength=E(this.struct);this.emptyBuffer=new ArrayBuffer(this.byteLength);a=this.struct;var c={},b;for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},read:function(a,
c){var b=this,e=this.endian,h=a instanceof DataView&&a||new DataView(a);if(0===a.byteLength||a.byteLength<this.byteLength)return Error("Uncaught IndexSizeError: Buffer size was zero byte.");this.offset=c||0;this._debug&&console.info("STRUCT.READ","byteLength:",a.byteLength,"readOffset:",this.offset);var r=z(this.struct,function(c,d,r){var f=[],q=c[0],m=c[1],k=c[2],n=c[3];c=w[q]||1;var g="uint8",p=0;s(k)&&(g=k,k=m.byteLength||m.length);if(a.byteLength<=b.offset)return Error("Uncaught IndexSizeError: Index or size was negative.");
!0===n&&(k=h["get"+y(g)](b.offset,e)/c,b.offset+=w[g],b._struct[d+"Size"]=[g,k*c],b._debug&&console.log(d+"Size",b._struct[d+"Size"],b.offset));if(v(m)){f=b.offset+k*c;if(a.byteLength<f)return Error("Uncaught IndexSizeError: Index or size was negative.");f=a.slice(b.offset,f);b.offset+=k*c}else for(;p<k;){x(q)?(c=a.slice(b.offset),f[p]=q.read(c),c=q.byteLength):f[p]=h["get"+y(q)](b.offset,e);if(f[p]&&f[p].constructor===Error)return f[p];b.offset+=c;p++}if(v(m)||s(m)||u(m)||1<k){if(s(m)){m=f;k=[];
f=m.length;for(c=0;c<f;)k[c]=String.fromCharCode(m[c]),c++;m=k.join("")}else m=f;r[d]=m}else r[d]=f[0];b._struct[d]=[q,r[d]];b._debug&&console.log(d,b._struct[d],b.offset)});r&&r.constructor===Error||(this.byteLength=this.offset);return r},write:function(a){var c=this,b=0,e=this.endian;a!==p&&this.update(a);var h=new DataView(this.emptyBuffer);this._debug&&console.info("STRUCT.WRITE","byteLength:",this.byteLength);z(this.struct,function(a,l){var d=[],g=a[0],d=a[1],f=a[2],q=a[3],m=w[g],k="uint8",n=
0;m===p&&x(g)&&(m=g.byteLength);s(f)&&(k=f,f=d.byteLength||d.length);!0===q&&(h["set"+y(k)](b,f*m,e),b+=w[k],c._struct[l+"Size"]=[k,f*m],c._debug&&console.log(l+"Size",c._struct[l+"Size"],b));c._struct[l]=[g,d];if(v(d)||s(d)||u(d)||1<f){v(d)&&Array.prototype.slice.call(new (C[y(g)+"Array"])(d));if(q=s(d))for(var q=[],k=d.length,t=0;t<k;)q[t]=d.charCodeAt(t),t++;d=q||d}else d=[d];for(;n<f;){if(x(g))for(q=g.write(),q=new Uint8Array(q),k=0;k<q.length;)h.setUint8(b,q[k],e),b+=1,k++;else h["set"+y(g)](b,
d[n],e);b+=m;n++}c._debug&&console.log(l,c._struct[l],b)});b!=this.emptyBuffer.byteLength&&console.warn("Incorrect buffer size writed");return h.buffer}};var w={int8:1,uint8:1,int16:2,uint16:2,int32:4,uint32:4,float32:4,int64:8,uint64:8,float64:8};if(DataView.prototype.getUint64===p&&DataView.prototype.setUint64===p&&DataView.prototype.getInt64===p&&DataView.prototype.setInt64===p){var n=function(a){return 0<=a&&31>a?1<<a:n[a]||(n[a]=Math.pow(2,a))},g=function(a,c){this.lo=a;this.hi=c};g.prototype=
{valueOf:function(){return this.lo+n(32)*this.hi},toString:function(){return Number.prototype.toString.apply(this.valueOf(),arguments)}};g.fromNumber=function(a){var c=Math.floor(a/n(32));a-=c*n(32);return new g(a,c)};var t=function(a,c){g.apply(this,arguments)};t.prototype="create"in Object?Object.create(g.prototype):new g;t.prototype.valueOf=function(){return this.hi<n(31)?g.prototype.valueOf.apply(this,arguments):-(n(32)-this.lo+n(32)*(n(32)-1-this.hi))};t.fromNumber=function(a){var c;0<=a?(c=
g.fromNumber(a),a=c.lo,c=c.hi):(c=Math.floor(a/n(32)),a-=c*n(32),c+=n(32));return new t(a,c)};DataView.prototype.getUint64=function(a,c){for(var b=c?[0,4]:[4,0],e=0;2>e;e++)b[e]=this.getUint32(a+b[e],c);return(new g(b[0],b[1])).valueOf()};DataView.prototype.setUint64=function(a,c,b){c=g.fromNumber(c);var e=b?{lo:0,hi:4}:{lo:4,hi:0},h;for(h in e)this.setUint32(a+e[h],c[h],b)};DataView.prototype.getInt64=function(a,c){for(var b=c?[0,4]:[4,0],e=0;2>e;e++)b[e]=this.getUint32(a+b[e],c);return(new t(b[0],
b[1])).valueOf()};DataView.prototype.setInt64=function(a,c){value=t.fromNumber(value);var b=c?{lo:0,hi:4}:{lo:4,hi:0},e;for(e in b)this.setUint32(a+b[e],value[e],c)}}C.Struct=A})(window);
