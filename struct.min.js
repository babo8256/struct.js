/*!
 * C-Like Data Structure for JavaScript.
 *
 * @author Joon Kyoung (aka. Firejune)
 * @license MIT
 * @version 0.5.2
 *
 */

(function(x,g){function r(a){return!!a&&a===Array||a.constructor===Array}function q(a){return!!a&&a===String||a.constructor===String}function s(a){return!!a&&a===ArrayBuffer||a.constructor===ArrayBuffer}function t(a){return a.charAt(0).toUpperCase()+a.slice(1)}function u(a,b){var c={},d;for(d in a)if(a.hasOwnProperty(d)){var k=a[d];k&&k===Object||k.constructor===Object?c[d]=u(k,b):b(k,d,c)}return c}function y(a,b){for(var c in b)a.hasOwnProperty(c)&&(a[c]&&a[c]===Object||a[c].constructor===Object?
a[c]=y(a[c],b[c]):a[c][1]=b[c]);return a}function D(a,b){return u(a,function(a,d,k){var v=(r(a)&&a[0]||a).toLowerCase(),f=q(a)?b:a[1],e=r(a)&&3<=a.length&&a[2]||(q(f)||r(f)||s(f))&&f.length||s(f)&&f.byteLength||1;a=r(a)&&(q(e)||1<e)?q(e)&&a[3]===g&&!0||a[3]:!1;k[d]=[v,f,e,a]})}function z(a){var b=0;u(a,function(a,d){var k=a[0],v=a[1],f=a[2],e=a[3],m="uint8";q(f)&&(m=f,f=v.byteLength||v.length);!0===e&&(b+=p[m]);b+=f*p[k]});return b}var A=function(a,b,c){this.endian=c==g&&!0||c;this.defaultValue=b||
0;this.struct=D(a,this.defaultValue);this.byteLength=z(this.struct);this.emptyBuffer=new ArrayBuffer(this.byteLength);this._debug=!1;this._struct={}};A.prototype={update:function(a){this.struct=y(this.struct,a);this.byteLength=z(this.struct);this.emptyBuffer=new ArrayBuffer(this.byteLength);a=this.struct;var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},read:function(a,b){var c=this,d=this.endian,k=a instanceof DataView&&a||new DataView(a);this.offset=b||0;this._debug&&console.info("STRUCT.READ",
"byteLength:",a.byteLength,"readOffset:",this.offset);return u(this.struct,function(b,f,e){var m=[],n=b[0],h=b[1],l=b[2];b=b[3];var w="uint8",g=0;q(l)&&(w=l,l=h.byteLength||h.length);!0===b&&(l=k["get"+t(w)](c.offset,d)/p[n],c.offset+=p[w],c._struct[f+"Size"]=[w,l*p[n]],c._debug&&console.log(f+"Size",c._struct[f+"Size"],c.offset));if(s(h))m=a.slice(c.offset,c.offset+l*p[n]),c.offset+=l*p[n];else for(;g<l;)m[g]=k["get"+t(n)](c.offset,d),c.offset+=p[n],g++;if(s(h)||q(h)||r(h)||1<l){if(q(h)){h=[];l=
m.length;for(b=0;b<l;)h[b]=String.fromCharCode(m[b]),b++;m=h.join("")}e[f]=m}else e[f]=m[0];c._struct[f]=[n,e[f]];c._debug&&console.log(f,c._struct[f],c.offset)})},write:function(a){var b=this,c=0,d=this.endian;a!==g&&this.update(a);var k=new DataView(this.emptyBuffer);this._debug&&console.info("STRUCT.WRITE","byteLength:",this.byteLength);u(this.struct,function(a,f){var e=[],m=a[0],e=a[1],n=a[2],h=a[3],l="uint8";q(n)&&(l=n,n=e.byteLength||e.length);!0===h&&(k["set"+t(l)](c,n*p[m],d),c+=p[l],b._struct[f+
"Size"]=[l,n*p[m]],b._debug&&console.log(f+"Size",b._struct[f+"Size"],c));b._struct[f]=[m,e];if(s(e)||q(e)||r(e)||1<n){s(e)&&Array.prototype.slice.call(new (x[t(m)+"Array"])(e));if(h=q(e))for(var h=[],l=e.length,g=0;g<l;)h[g]=e.charCodeAt(g),g++;e=h||e}else e=[e];for(h=0;h<n;h++)k["set"+t(m)](c,e[h],d),c+=p[m];b._debug&&console.log(f,b._struct[f],c)});c!=this.emptyBuffer.byteLength&&console.warn("Incorrect write buffer size");return k.buffer}};var p={int8:1,uint8:1,int16:2,uint16:2,int32:4,uint32:4,
float32:4,int64:8,uint64:8,float64:8};if(DataView.prototype.getUint64===g&&DataView.prototype.setUint64===g&&DataView.prototype.getInt64===g&&DataView.prototype.setInt64===g){var B=4294967296*4294967296,C=B/2,d=function(a,b,c){this.low=a|0;this.high=b|0;this.unsigned=!!c};d.prototype={equals:function(a){return this.unsigned!=a.unsigned&&this.high>>>31!=a.high>>>31?!1:this.high==a.high&&this.low==a.low},not:function(){return d.fromBits(~this.low,~this.high,this.unsigned)},add:function(a){var b=this.high>>>
16,c=this.high&65535,g=this.low>>>16,k=a.high>>>16,p=a.high&65535,f=a.low>>>16,e;e=0+((this.low&65535)+(a.low&65535));a=0+(e>>>16);a+=g+f;g=0+(a>>>16);g+=c+p;c=0+(g>>>16);c=c+(b+k)&65535;return d.fromBits((a&65535)<<16|e&65535,c<<16|g&65535,this.unsigned)},negate:function(){return!this.unsigned&&this.equals(d.MIN_SIGNED_VALUE)?d.MIN_SIGNED_VALUE:this.not().add(d.ONE)},toInt:function(){return this.unsigned?this.low>>>0:this.low},getHighBitsUnsigned:function(){return this.high>>>0},getLowBitsUnsigned:function(){return this.low>>>
0},getLowBits:function(){return this.low},getHighBits:function(){return this.high}};d.fromBits=function(a,b,c){return new d(a,b,c)};d.fromInt=function(a,b){if(b)return a>>>=0,new d(a,0>(a|0)?-1:0,!0);a|=0;return new d(a,0>a?-1:0,!1)};d.fromNumber=function(a,b){b=!!b;return isNaN(a)||!isFinite(a)?d.ZERO:!b&&a<=-C?d.MIN_SIGNED_VALUE:b&&0>=a?d.MIN_UNSIGNED_VALUE:!b&&a+1>=C?d.MAX_SIGNED_VALUE:b&&a>=B?d.MAX_UNSIGNED_VALUE:0>a?d.fromNumber(-a,!1).negate():new d(a%4294967296|0,a/4294967296|0,b)};d.ZERO=
d.fromInt(0);d.ONE=d.fromInt(1);d.MAX_SIGNED_VALUE=d.fromBits(-1,2147483647,!1);d.MAX_UNSIGNED_VALUE=d.fromBits(-1,-1,!0);d.MIN_SIGNED_VALUE=d.fromBits(0,-2147483648,!1);d.MIN_UNSIGNED_VALUE=d.fromBits(0,0,!0);DataView.prototype.getUint64=function(a,b){return(b?d.fromBits(this.getUint32(a,!0),this.getUint32(a+4,!0),!0):d.fromBits(this.getUint32(a+4,!1),this.getUint32(a,!1),!0)).toInt()};DataView.prototype.setUint64=function(a,b,c){b=d.fromNumber(b,!0);c?(this.setUint32(a,b.getLowBitsUnsigned(),!0),
this.setUint32(a+4,b.getHighBitsUnsigned(),!0)):(this.setUint32(a,b.getHighBitsUnsigned(),!1),this.setUint32(a+4,b.getLowBitsUnsigned(),!1))};DataView.prototype.getInt64=function(a,b){return(b?d.fromBits(this.getInt32(a,!0),this.getInt32(a+4,!0),!1):d.fromBits(this.getInt32(a+4,!1),this.getInt32(a,!1),!1)).toInt()};DataView.prototype.setInt64=function(a,b){value=d.fromNumber(value,!1);b?(this.setInt32(a,value.getLowBits(),!0),this.setInt32(a+4,value.getHighBits(),!0)):(this.setInt32(a,value.getHighBits(),
!1),this.setInt32(a+4,value.getLowBits(),!1))}}x.Struct=A})(window);
